To prune a Parallax client at least 40 GB of free disk space is recommended. This means pruning cannot be used to save a hard drive that has been completely filled. A good rule of thumb is to prune before the node fills \~80% of the available disk space.

## Pruning rules

1. Do not try to prune an archive node. Archive nodes need to maintain ALL historic data by definition.
2. Ensure there is at least 40 GB of storage space still available on the disk that will be pruned. Failures have been reported with \~25GB of free space.
3. Parallax client is fully sync'd
4. Parallax client has finished creating a snapshot that is at least 128 blocks old. This is true when "state snapshot generation" is no longer reported in the logs.

With these rules satisfied, the Parallax client's database can be pruned.

## How pruning works

Pruning uses snapshots of the state database as an indicator to determine which nodes in the state trie can be kept and which ones are stale and can be discarded. The Parallax client identifies the target state trie based on a stored snapshot layer which has at least 128 block confirmations on top (for surviving reorgs) data that isn't part of the target state trie or genesis state.

The Parallax client prunes the database in three stages:

1. Iterating state snapshot: the Parallax client iterates the bottom-most snapshot layer and constructs a bloom filter set for identifying the target trie nodes.
2. Pruning state data: the Parallax client deletes stale trie nodes from the database which are not in the bloom filter set.
3. Compacting database: the Parallax client tidies up the new database to reclaim free space.

There may be a period of >1 hour during the Compacting Database stage with no log messages at all. This is normal, and the pruning should be left to run until finally a log message containing the phrase `State pruning successful` appears (i.e. do not restart the Parallax client yet!). That message indicates that the pruning is complete and the client can be started.

## Pruning command

For a normal Parallax node, the client should be stopped and the following command executed to start a offline state prune:

```sh
prlx snapshot prune-state
```

For a Parallax client run using systemd:

```sh
sudo systemctl stop prlx # stop prlx, wait >3mins to ensure clean shutdown
tmux # tmux enables pruning to keep running even if you disconnect
sudo -u <user> prlx --datadir <path> snapshot prune-state # wait for pruning to finish
sudo systemctl start prlx # restart prlx
```

The pruning could take 4-5 hours to complete. Once finished, restart the Parallax client.

## Troubleshooting

Messages about "state snapshot generation" indicate that a snapshot is not fully generated. This suggests either the `--datadir` is not correct or the Parallax client ran out of time to complete the snapshot generation and the pruning began before the snapshot was completed. In either case, the best course of action is to stop the client, run it normally again (no pruning) until the snapshot is definitely complete and at least 128 blocks exist on top of it, then try pruning again.
